# Copyright 2018 FIX94
# This code is licensed to you under the terms of the GNU GPL, version 2;
# see file LICENSE or http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt

# Modifications made by AECX and Zephiles

#---------------------------------------------------------------------------------
# Clear the implicit built in rules
#---------------------------------------------------------------------------------
.SUFFIXES:
#---------------------------------------------------------------------------------
ifeq ($(strip $(DEVKITPPC)),)
$(error "Please set DEVKITPPC in your environment. export DEVKITPPC=<path to>/devkitPPC")
endif

CC = $(DEVKITPPC)/bin/powerpc-eabi-gcc
OBJCOPY = $(DEVKITPPC)/bin/powerpc-eabi-objcopy

LD = $(DEVKITPPC)/bin/powerpc-eabi-ld

# The compiler flags we need.

CFLAGS := -Wall -W -Oz -ffreestanding -mno-eabi -mno-sdata -mcpu=750

ifeq ($(VERSION),)
all: us eu0 eu1
us:
	@$(MAKE) --no-print-directory VERSION=us
eu0:
	@$(MAKE) --no-print-directory VERSION=eu0
eu1:
	@$(MAKE) --no-print-directory VERSION=eu1

else

# Platform options
ifeq ($(VERSION),us)
	PRINTVER = US
else ifeq ($(VERSION),eu0)
	PRINTVER = EU0
else ifeq ($(VERSION),eu1)
	PRINTVER = EU1
endif

all: $(PRINTVER).bin

sola.%.o:
	@$(CC) $(CFLAGS) -DSOLA_$(PRINTVER) -c sola.c -o $@

start.o:
	@$(CC) $(CFLAGS) -c start.S -o start.o

%.elf: start.o sola.$(PRINTVER).o
	@echo "Linking... $@"
	@$(LD) -T sola.ld $^ -o $@ -Map=Main_$(PRINTVER).map

%.bin: sola.$(PRINTVER).elf
	@echo "Building... $@"
	@$(OBJCOPY) -Obinary $< Main_$(PRINTVER).bin

endif
clean:
	-rm -f *.o *.elf *.map *.bin